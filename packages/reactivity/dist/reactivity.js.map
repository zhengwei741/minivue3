{
  "version": 3,
  "sources": ["../src/effect.ts", "../src/reactive.ts", "../src/ref.ts", "../src/computed.ts", "../src/index.ts"],
  "sourcesContent": ["const targetMap = new WeakMap()\r\n// {\r\n//   depsMap: {\r\n//     key: [dep, dep]\r\n//   }\r\n// }\r\n\r\n// \u5F53\u524D\u6267\u884C\u7684effect\r\nlet activeEffect\r\n\r\nexport class ReactiveEffect {\r\n  deps = new Set()\r\n\r\n  public onStop?\r\n\r\n  public active = true\r\n\r\n  constructor(public fn, public scheduler?) {\r\n    this.fn = fn\r\n  }\r\n\r\n  run() {\r\n    // \u8BBE\u7F6E\u5F53\u524Deffect\r\n    activeEffect = this\r\n\r\n    // \u6267\u884Cfn\r\n    // \u4F1A\u89E6\u53D1fn\u4E2D\u7684get get\u4E2D\u6536\u96C6\u5F53\u524DactiveEffect\r\n    // \u5728set\u4E2D\u89E6\u53D1\u641C\u96C6\u7684effect\r\n    const ret = this.fn()\r\n\r\n    activeEffect = undefined\r\n\r\n    return ret\r\n  }\r\n\r\n  stop() {\r\n    if (this.active) {\r\n      cleanupEffect(this)\r\n      if (this.onStop) {\r\n        this.onStop()\r\n      }\r\n      this.active = false\r\n    }\r\n  }\r\n}\r\n\r\nfunction cleanupEffect(effect) {\r\n  effect.deps.forEach((dep) => {\r\n    dep.delete(effect)\r\n  })\r\n  effect.deps.length = 0\r\n}\r\n\r\nexport function effect(fn) {\r\n  const _effect = new ReactiveEffect(fn)\r\n\r\n  _effect.run()\r\n}\r\n\r\nexport function track(target, key) {\r\n  let depsMap = targetMap.get(target)\r\n\r\n  if (!depsMap) {\r\n    targetMap.set(target, (depsMap = new Map()))\r\n  }\r\n  let deps = depsMap.get(key)\r\n  if (!deps) {\r\n    depsMap.set(key, (deps = new Set()))\r\n  }\r\n\r\n  if (activeEffect) {\r\n    trackEffect(deps)\r\n  }\r\n}\r\n\r\nexport function trackEffect(deps) {\r\n  if (activeEffect && !deps.has(activeEffect)) {\r\n    deps.add(activeEffect)\r\n    // activeEffect.push(deps)\r\n  }\r\n}\r\n\r\nexport function trigger(target, key, value) {\r\n  const depsMap = targetMap.get(target)\r\n  if (!depsMap) {\r\n    return\r\n  }\r\n\r\n  let deps = depsMap.get(key) || []\r\n\r\n  triggerEffect(deps)\r\n}\r\n\r\nexport function triggerEffect(deps) {\r\n  for (const effect of deps) {\r\n    if (effect.scheduler) {\r\n      effect.scheduler()\r\n    } else {\r\n      effect.run()\r\n    }\r\n  }\r\n}\r\n", "import { track, trigger } from './effect'\r\n\r\nconst proxyMap = new WeakMap()\r\n// {\r\n//   target: proxy\r\n// }\r\n\r\nexport function reactive(target) {\r\n  return createReactiveObject(target)\r\n}\r\n\r\nexport const enum ReactiveFlags {\r\n  IS_REACTIVE = \"__v_isReactive\",\r\n}\r\n\r\nexport const isReactive = (value) => {\r\n  return !!value[ReactiveFlags.IS_REACTIVE];\r\n}\r\n\r\nfunction createReactiveObject(target) {\r\n  const existsProxy = proxyMap.get(target)\r\n\r\n  if (existsProxy) {\r\n    return existsProxy\r\n  }\r\n\r\n  const proxy = new Proxy(target, {\r\n    get (target,key,reactive) {\r\n      \r\n      // \u662F\u5426\u54CD\u5E94\u5F0F\u6807\u8BC6__v_isReactive\r\n      if (key === ReactiveFlags.IS_REACTIVE) {\r\n        return true\r\n      }\r\n\r\n      // Reflect \u53EF\u4EE5\u4FEE\u6B63 this\r\n      const res = Reflect.get(target, key, reactive)\r\n      // \u6536\u96C6\u4F9D\u8D56\r\n      track(target, key)\r\n\r\n      return res\r\n    },\r\n    set(target, key, value, reactive) {\r\n      Reflect.set(target, key, value, reactive)\r\n      // \u89E6\u53D1\r\n      trigger(target, key, value)\r\n\r\n      return true\r\n    }\r\n  })\r\n\r\n  proxyMap.set(target, proxy)\r\n\r\n  return proxy\r\n}\r\n\r\n// let value = reactive({\r\n//   name: 'tom',\r\n//   age: 10\r\n// })\r\n\r\n// effect(() => {\r\n//   console.log(value.name)\r\n//   console.log(value.age)\r\n// })\r\n\r\n// value.name = 'tom++'\r\n\r\n// value.age = 20\r\n", "import { trackEffect, triggerEffect } from './effect'\r\nimport { reactive } from './reactive'\r\n\r\nclass RefImp {\r\n  public rawValue\r\n  public _value\r\n  public deps = new Set()\r\n  __v_isRef = true\r\n  constructor(target) {\r\n    this.rawValue = target\r\n    this._value = target\r\n  }\r\n\r\n  get value() {\r\n    trackEffect(this.deps)\r\n    return this._value\r\n  }\r\n\r\n  set value(newValue) {\r\n    if (!Object.is(this.rawValue, newValue)) {\r\n      this._value = typeof newValue === 'object' ? reactive(newValue) : newValue\r\n      this.rawValue = newValue\r\n      triggerEffect(this.deps)\r\n    }\r\n  }\r\n}\r\n\r\nfunction createRef(target) {\r\n  const ref = new RefImp(target)\r\n\r\n  return ref\r\n}\r\n\r\nexport function isRef(value) {\r\n  return !!(value && value.__v_isRef === true)\r\n}\r\n\r\nexport function ref(target) {\r\n  return createRef(target)\r\n}\r\n", "import { ReactiveEffect, trackEffect, triggerEffect } from './effect'\r\n\r\nclass ComputedImpl {\r\n  deps = new Set()\r\n  effect: ReactiveEffect\r\n\r\n  _dirty: boolean\r\n  _value: unknown\r\n\r\n  constructor(fn) {\r\n    this._dirty = true\r\n    this.effect = new ReactiveEffect(fn, () => {\r\n      // \u4F9D\u8D56\u7684\u503C\u4E00\u65E6\u4FEE\u6539\u4F1A\u8C03\u7528\u8FD9\u91CC\r\n      if (this._dirty) {\r\n        return\r\n      }\r\n      // \u89E3\u9501 \u8C03\u7528 value \u4F1A\u83B7\u5F97\u6700\u65B0\u7684\u503C\r\n      this._dirty = true\r\n      triggerEffect(this.deps)\r\n    })\r\n  }\r\n\r\n  get value() {\r\n    trackEffect(this.deps)\r\n    // \u7B2C\u4E00\u6B21\u80AF\u5B9A\u4E3Atrue\r\n    // \u52A0\u9501 \u5B9E\u73B0\u7F13\u5B58\r\n    if (this._dirty) {\r\n      this._dirty = false\r\n      // \u6267\u884C\u4F20\u5165fn\r\n      // \u5728\u6267\u884Crun \u7684\u65F6\u5019 fn \u4E2D\u7684\u54CD\u5E94\u5F0F\u5BF9\u8C61\u4F1A\u6536\u96C6\u5230 \u8FD9\u4E2Aeffect\r\n      // \u4E00\u65E6\u4FEE\u6539\u4F1A\u89E6\u53D1\u4E0A\u9762\u7684scheduler\u56DE\u8C03\u8FDB\u884C\u89E3\u9501\r\n      this._value = this.effect.run()\r\n    }\r\n    return this._value\r\n  }\r\n}\r\n\r\nexport function computed(fn) {\r\n  return createComputed(fn)\r\n}\r\n\r\nfunction createComputed(fn) {\r\n  return new ComputedImpl(fn)\r\n}\r\n\r\n// const ref = ref(0)\r\n\r\n// const cmp = computed(() => ref.value + 100)\r\n\r\n// ref.value++\r\n\r\n// console.log(cmp.value)\r\n", "import { reactive } from './reactive'\r\nimport { ref } from './ref'\r\nimport { effect } from './effect'\r\nimport { computed } from './computed'\r\n\r\nconst num = ref(0)\r\n\r\n// const man = reactive({ name: 'tom', age: 18 })\r\n\r\n// effect(() => {\r\n//   console.log(num.value)\r\n//   // console.log(man.name)\r\n//   console.log('effect')\r\n// })\r\n\r\n// num.value++\r\n// man.name = 'jack'\r\n\r\nconst com = computed(() => {\r\n  return num.value + 100\r\n})\r\n\r\nnum.value++\r\n\r\nconsole.log(com.value)\r\n"],
  "mappings": "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",
  "names": ["target", "reactive", "ref"]
}
