{
  "version": 3,
  "sources": ["../../reactivity/src/effect.ts", "../../reactivity/src/reactive.ts", "../../reactivity/src/ref.ts", "../src/apiWatch.ts", "../src/index.ts"],
  "sourcesContent": ["const targetMap = new WeakMap()\r\n// {\r\n//   depsMap: {\r\n//     key: [dep, dep]\r\n//   }\r\n// }\r\n\r\n// \u5F53\u524D\u6267\u884C\u7684effect\r\nlet activeEffect\r\n\r\nexport class ReactiveEffect {\r\n  deps = new Set()\r\n\r\n  public onStop?\r\n\r\n  public active = true\r\n\r\n  constructor(public fn, public scheduler?) {\r\n    this.fn = fn\r\n  }\r\n\r\n  run() {\r\n    // \u8BBE\u7F6E\u5F53\u524Deffect\r\n    activeEffect = this\r\n\r\n    // \u6267\u884Cfn\r\n    // \u4F1A\u89E6\u53D1fn\u4E2D\u7684get get\u4E2D\u6536\u96C6\u5F53\u524DactiveEffect\r\n    // \u5728set\u4E2D\u89E6\u53D1\u641C\u96C6\u7684effect\r\n    const ret = this.fn()\r\n\r\n    activeEffect = undefined\r\n\r\n    return ret\r\n  }\r\n\r\n  stop() {\r\n    if (this.active) {\r\n      cleanupEffect(this)\r\n      if (this.onStop) {\r\n        this.onStop()\r\n      }\r\n      this.active = false\r\n    }\r\n  }\r\n}\r\n\r\nfunction cleanupEffect(effect) {\r\n  effect.deps.forEach((dep) => {\r\n    dep.delete(effect)\r\n  })\r\n  effect.deps.length = 0\r\n}\r\n\r\nexport function effect(fn) {\r\n  const _effect = new ReactiveEffect(fn)\r\n\r\n  _effect.run()\r\n}\r\n\r\nexport function track(target, key) {\r\n  let depsMap = targetMap.get(target)\r\n\r\n  if (!depsMap) {\r\n    targetMap.set(target, (depsMap = new Map()))\r\n  }\r\n  let deps = depsMap.get(key)\r\n  if (!deps) {\r\n    depsMap.set(key, (deps = new Set()))\r\n  }\r\n\r\n  if (activeEffect) {\r\n    trackEffect(deps)\r\n  }\r\n}\r\n\r\nexport function trackEffect(deps) {\r\n  if (activeEffect && !deps.has(activeEffect)) {\r\n    deps.add(activeEffect)\r\n    // activeEffect.push(deps)\r\n  }\r\n}\r\n\r\nexport function trigger(target, key, value) {\r\n  const depsMap = targetMap.get(target)\r\n  if (!depsMap) {\r\n    return\r\n  }\r\n\r\n  let deps = depsMap.get(key) || []\r\n\r\n  triggerEffect(deps)\r\n}\r\n\r\nexport function triggerEffect(deps) {\r\n  for (const effect of deps) {\r\n    if (effect.scheduler) {\r\n      effect.scheduler()\r\n    } else {\r\n      effect.run()\r\n    }\r\n  }\r\n}\r\n", "import { track, trigger } from './effect'\r\n\r\nconst proxyMap = new WeakMap()\r\n// {\r\n//   target: proxy\r\n// }\r\n\r\nexport function reactive(target) {\r\n  return createReactiveObject(target)\r\n}\r\n\r\nexport const enum ReactiveFlags {\r\n  IS_REACTIVE = \"__v_isReactive\",\r\n}\r\n\r\nexport const isReactive = (value) => {\r\n  return !!value[ReactiveFlags.IS_REACTIVE];\r\n}\r\n\r\nfunction createReactiveObject(target) {\r\n  const existsProxy = proxyMap.get(target)\r\n\r\n  if (existsProxy) {\r\n    return existsProxy\r\n  }\r\n\r\n  const proxy = new Proxy(target, {\r\n    get (target,key,reactive) {\r\n      \r\n      // \u662F\u5426\u54CD\u5E94\u5F0F\u6807\u8BC6__v_isReactive\r\n      if (key === ReactiveFlags.IS_REACTIVE) {\r\n        return true\r\n      }\r\n\r\n      // Reflect \u53EF\u4EE5\u4FEE\u6B63 this\r\n      const res = Reflect.get(target, key, reactive)\r\n      // \u6536\u96C6\u4F9D\u8D56\r\n      track(target, key)\r\n\r\n      return res\r\n    },\r\n    set(target, key, value, reactive) {\r\n      Reflect.set(target, key, value, reactive)\r\n      // \u89E6\u53D1\r\n      trigger(target, key, value)\r\n\r\n      return true\r\n    }\r\n  })\r\n\r\n  proxyMap.set(target, proxy)\r\n\r\n  return proxy\r\n}\r\n\r\n// let value = reactive({\r\n//   name: 'tom',\r\n//   age: 10\r\n// })\r\n\r\n// effect(() => {\r\n//   console.log(value.name)\r\n//   console.log(value.age)\r\n// })\r\n\r\n// value.name = 'tom++'\r\n\r\n// value.age = 20\r\n", "import { trackEffect, triggerEffect } from './effect'\r\nimport { reactive } from './reactive'\r\n\r\nclass RefImp {\r\n  public rawValue\r\n  public _value\r\n  public deps = new Set()\r\n  __v_isRef = true\r\n  constructor(target) {\r\n    this.rawValue = target\r\n    this._value = target\r\n  }\r\n\r\n  get value() {\r\n    trackEffect(this.deps)\r\n    return this._value\r\n  }\r\n\r\n  set value(newValue) {\r\n    if (!Object.is(this.rawValue, newValue)) {\r\n      this._value = typeof newValue === 'object' ? reactive(newValue) : newValue\r\n      this.rawValue = newValue\r\n      triggerEffect(this.deps)\r\n    }\r\n  }\r\n}\r\n\r\nfunction createRef(target) {\r\n  const ref = new RefImp(target)\r\n\r\n  return ref\r\n}\r\n\r\nexport function isRef(value) {\r\n  return !!(value && value.__v_isRef === true)\r\n}\r\n\r\nexport function ref(target) {\r\n  return createRef(target)\r\n}\r\n", "import { reactive, isReactive } from 'packages/reactivity/src/reactive'\r\nimport { ReactiveEffect } from 'packages/reactivity/src/effect'\r\nimport { isRef } from 'packages/reactivity/src/ref'\r\n\r\nexport function watch(source, cb, options?) {\r\n  return doWatch(source, cb, options)\r\n}\r\n\r\nfunction doWatch(source, cb, options) {\r\n  let getter: () => any\r\n  let deep\r\n  const { immediate } = options || {}\r\n\r\n  if (isReactive(source)) {\r\n    getter = () => source\r\n    deep = true\r\n  }\r\n\r\n  if (deep && cb) {\r\n    const baseGetter = getter\r\n    getter = () => traverse(baseGetter())\r\n  }\r\n\r\n  const effect = new ReactiveEffect(getter, () => {\r\n    if (typeof cb === 'function') {\r\n      cb(123)\r\n    }\r\n  })\r\n\r\n  if (immediate) {\r\n    effect.run()\r\n  }\r\n\r\n  return () => {\r\n    effect.stop()\r\n  }\r\n}\r\n\r\n// \u9012\u5F52\u8C03\u7528 \u8F6C\u6362\u4E3A\u54CD\u5E94\u5F0F\u5BF9\u8C61\r\nfunction traverse(value, seen?) {\r\n  if (typeof value !== 'object') {\r\n    return value\r\n  }\r\n  seen = seen || new Set()\r\n\r\n  if (seen.has(value)) {\r\n    return value\r\n  }\r\n  if (isRef(value)) {\r\n    traverse(value.value, seen)\r\n  }\r\n  // \u8FD8\u6709\u6570\u7EC4 map \u7B49\u60C5\u51B5\r\n  if (Object.prototype.toString.call(value) === '[object Object]') {\r\n    for (const key in value) {\r\n      traverse(value[key], seen)\r\n    }\r\n  }\r\n}\r\n\r\n// const tom = reactive({ name: 'tom' })\r\n\r\n// watch(tom, (newValue, oldValue) => {}, {})\r\n", "import { watch } from './apiWatch'\r\nimport { reactive } from 'packages/reactivity/src/reactive'\r\n\r\nconst tom = reactive({ name: 'tom' })\r\n\r\nwatch(tom, (value) => {\r\n  console.log(value)\r\n})\r\n\r\ntom.name = 'tom2'\r\n"],
  "mappings": "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",
  "names": ["target", "reactive"]
}
