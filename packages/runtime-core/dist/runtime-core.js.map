{
  "version": 3,
  "sources": ["../../reactivity/src/effect.ts", "../../reactivity/src/reactive.ts", "../../reactivity/src/ref.ts", "../src/apiWatch.ts", "../../shared/src/shapeFlags.ts", "../src/vnode.ts", "../src/apiCreateApp.ts", "../src/renderer.ts"],
  "sourcesContent": ["const targetMap = new WeakMap()\r\n// {\r\n//   depsMap: {\r\n//     key: [dep, dep]\r\n//   }\r\n// }\r\n\r\n// \u5F53\u524D\u6267\u884C\u7684effect\r\nlet activeEffect\r\n\r\nexport class ReactiveEffect {\r\n  deps = new Set()\r\n\r\n  public onStop?\r\n\r\n  public active = true\r\n\r\n  constructor(public fn, public scheduler?) {\r\n    this.fn = fn\r\n  }\r\n\r\n  run() {\r\n    // \u8BBE\u7F6E\u5F53\u524Deffect\r\n    activeEffect = this\r\n\r\n    // \u6267\u884Cfn\r\n    // \u4F1A\u89E6\u53D1fn\u4E2D\u7684get get\u4E2D\u6536\u96C6\u5F53\u524DactiveEffect\r\n    // \u5728set\u4E2D\u89E6\u53D1\u641C\u96C6\u7684effect\r\n    const ret = this.fn()\r\n\r\n    activeEffect = undefined\r\n\r\n    return ret\r\n  }\r\n\r\n  stop() {\r\n    if (this.active) {\r\n      cleanupEffect(this)\r\n      if (this.onStop) {\r\n        this.onStop()\r\n      }\r\n      this.active = false\r\n    }\r\n  }\r\n}\r\n\r\nfunction cleanupEffect(effect) {\r\n  effect.deps.forEach((dep) => {\r\n    dep.delete(effect)\r\n  })\r\n  effect.deps.length = 0\r\n}\r\n\r\nexport function effect(fn) {\r\n  const _effect = new ReactiveEffect(fn)\r\n\r\n  _effect.run()\r\n}\r\n\r\nexport function track(target, key) {\r\n  let depsMap = targetMap.get(target)\r\n\r\n  if (!depsMap) {\r\n    targetMap.set(target, (depsMap = new Map()))\r\n  }\r\n  let deps = depsMap.get(key)\r\n  if (!deps) {\r\n    depsMap.set(key, (deps = new Set()))\r\n  }\r\n\r\n  if (activeEffect) {\r\n    trackEffect(deps)\r\n  }\r\n}\r\n\r\nexport function trackEffect(deps) {\r\n  if (activeEffect && !deps.has(activeEffect)) {\r\n    deps.add(activeEffect)\r\n    // activeEffect.push(deps)\r\n  }\r\n}\r\n\r\nexport function trigger(target, key, value) {\r\n  const depsMap = targetMap.get(target)\r\n  if (!depsMap) {\r\n    return\r\n  }\r\n\r\n  let deps = depsMap.get(key) || []\r\n\r\n  triggerEffect(deps)\r\n}\r\n\r\nexport function triggerEffect(deps) {\r\n  deps.forEach((effect) => {\r\n    if (effect.scheduler) {\r\n      effect.scheduler()\r\n    } else {\r\n      effect.run()\r\n    }\r\n  })\r\n  // for (const effect of deps) {\r\n  //   if (effect.scheduler) {\r\n  //     effect.scheduler()\r\n  //   } else {\r\n  //     effect.run()\r\n  //   }\r\n  // }\r\n}\r\n", "import { track, trigger } from './effect'\r\n\r\nconst proxyMap = new WeakMap()\r\n// {\r\n//   target: proxy\r\n// }\r\n\r\nexport function reactive(target) {\r\n  return createReactiveObject(target)\r\n}\r\n\r\nexport const enum ReactiveFlags {\r\n  IS_REACTIVE = '__v_isReactive'\r\n}\r\n\r\nexport const isReactive = (value) => {\r\n  return !!value[ReactiveFlags.IS_REACTIVE]\r\n}\r\n\r\nfunction createReactiveObject(target) {\r\n  const existsProxy = proxyMap.get(target)\r\n\r\n  if (existsProxy) {\r\n    return existsProxy\r\n  }\r\n\r\n  const proxy = new Proxy(target, {\r\n    get(target, key, reactive) {\r\n      // \u662F\u5426\u54CD\u5E94\u5F0F\u6807\u8BC6__v_isReactive\r\n      if (key === ReactiveFlags.IS_REACTIVE) {\r\n        return true\r\n      }\r\n\r\n      // Reflect \u53EF\u4EE5\u4FEE\u6B63 this\r\n      const res = Reflect.get(target, key, reactive)\r\n      // \u6536\u96C6\u4F9D\u8D56\r\n      track(target, key)\r\n\r\n      // \u6DF1\u5EA6\u76D1\u542C\r\n      if (typeof res === 'object' && res !== null) {\r\n        return reactive(res)\r\n      }\r\n\r\n      return res\r\n    },\r\n    set(target, key, value, reactive) {\r\n      Reflect.set(target, key, value, reactive)\r\n      // \u89E6\u53D1\r\n      trigger(target, key, value)\r\n\r\n      return true\r\n    }\r\n  })\r\n\r\n  proxyMap.set(target, proxy)\r\n\r\n  return proxy\r\n}\r\n\r\n// let value = reactive({\r\n//   name: 'tom',\r\n//   age: 10\r\n// })\r\n\r\n// effect(() => {\r\n//   console.log(value.name)\r\n//   console.log(value.age)\r\n// })\r\n\r\n// value.name = 'tom++'\r\n\r\n// value.age = 20\r\n", "import { trackEffect, triggerEffect } from './effect'\r\nimport { reactive } from './reactive'\r\n\r\nclass RefImp {\r\n  public rawValue\r\n  public _value\r\n  public deps = new Set()\r\n  __v_isRef = true\r\n  constructor(target) {\r\n    this.rawValue = target\r\n    this._value = target\r\n  }\r\n\r\n  get value() {\r\n    trackEffect(this.deps)\r\n    return this._value\r\n  }\r\n\r\n  set value(newValue) {\r\n    if (!Object.is(this.rawValue, newValue)) {\r\n      this._value = typeof newValue === 'object' ? reactive(newValue) : newValue\r\n      this.rawValue = newValue\r\n      triggerEffect(this.deps)\r\n    }\r\n  }\r\n}\r\n\r\nfunction createRef(target) {\r\n  const ref = new RefImp(target)\r\n\r\n  return ref\r\n}\r\n\r\nexport function isRef(value) {\r\n  return !!(value && value.__v_isRef === true)\r\n}\r\n\r\nexport function ref(target) {\r\n  return createRef(target)\r\n}\r\n", "import { isReactive, ReactiveEffect, isRef } from '@minivue/reactivity'\r\n\r\nexport function watch(source, cb, options?) {\r\n  return doWatch(source, cb, options)\r\n}\r\n\r\nfunction doWatch(source, cb, options) {\r\n  let getter: () => any\r\n  let deep\r\n  let oldValue\r\n  const { immediate } = options || {}\r\n\r\n  if (isReactive(source)) {\r\n    getter = () => source\r\n    deep = true\r\n  } else if (typeof source === 'function') {\r\n    getter = source\r\n  }\r\n\r\n  if (deep && cb) {\r\n    const baseGetter = getter\r\n    getter = () => traverse(baseGetter())\r\n  }\r\n\r\n  const effect = new ReactiveEffect(getter, () => {\r\n    if (typeof cb === 'function') {\r\n      let newValue = effect.run()\r\n      cb(oldValue, newValue)\r\n      oldValue = newValue\r\n    }\r\n  })\r\n\r\n  // if (immediate) {\r\n  //   effect.run()\r\n  // }\r\n  if (cb) {\r\n    oldValue = effect.run()\r\n  }\r\n\r\n  return () => {\r\n    effect.stop()\r\n  }\r\n}\r\n\r\n// \u9012\u5F52\u8C03\u7528\r\nfunction traverse(value, seen?) {\r\n  if (typeof value !== 'object') {\r\n    return value\r\n  }\r\n  seen = seen || new Set()\r\n\r\n  if (seen.has(value)) {\r\n    return value\r\n  }\r\n  if (isRef(value)) {\r\n    traverse(value.value, seen)\r\n  }\r\n  // \u8FD8\u6709\u6570\u7EC4 map \u7B49\u60C5\u51B5\r\n  if (Object.prototype.toString.call(value) === '[object Object]') {\r\n    for (const key in value) {\r\n      traverse(value[key], seen)\r\n    }\r\n  }\r\n  return value\r\n}\r\n\r\n// const tom = reactive({ name: 'tom' })\r\n\r\n// watch(tom, (newValue, oldValue) => {}, {})\r\n", "export const enum ShapeFlags {\r\n  ELEMENT = 1,\r\n  FUNCTIONAL_COMPONENT = 1 << 1,\r\n  STATEFUL_COMPONENT = 1 << 2,\r\n  TEXT_CHILDREN = 1 << 3,\r\n  ARRAY_CHILDREN = 1 << 4,\r\n  SLOTS_CHILDREN = 1 << 5,\r\n  TELEPORT = 1 << 6,\r\n  SUSPENSE = 1 << 7,\r\n  COMPONENT_SHOULD_KEEP_ALIVE = 1 << 8,\r\n  COMPONENT_KEPT_ALIVE = 1 << 9,\r\n  COMPONENT = ShapeFlags.STATEFUL_COMPONENT | ShapeFlags.FUNCTIONAL_COMPONENT\r\n}\r\n\r\nexport const isFunction = (val: unknown): val is Function =>\r\n  typeof val === 'function'\r\nexport const isString = (val: unknown): val is string => typeof val === 'string'\r\nexport const isObject = (val: unknown): val is Record<any, any> =>\r\n  val !== null && typeof val === 'object'\r\n", "import { ShapeFlags, isString, isFunction, isObject } from '@minivue/shared'\r\n\r\nexport function createVNode(type) {\r\n  const shapeFlag = isString(type)\r\n    ? ShapeFlags.ELEMENT //\r\n    : isObject(type)\r\n    ? ShapeFlags.STATEFUL_COMPONENT // \u7528\u6237\u8BBE\u7F6Eoptions\r\n    : isFunction(type)\r\n    ? ShapeFlags.FUNCTIONAL_COMPONENT //\r\n    : 0\r\n\r\n  return createBaseVNode(type, shapeFlag)\r\n}\r\n\r\nfunction createBaseVNode(type, shapeFlag) {\r\n  const vnode = {\r\n    el: null,\r\n    type,\r\n    shapeFlag,\r\n    // TODO text \u7C7B\u578B\r\n    children: '123'\r\n  }\r\n  return vnode\r\n}\r\n\r\nexport const Text = Symbol('Text')\r\n", "import { createVNode } from './vnode'\r\n\r\nexport function createAppAPI(render) {\r\n  // app \u6839\u7EC4\u4EF6\r\n  return function createApp(rootComponent, rootProps = null) {\r\n    const app = {\r\n      mount(rootContainer) {\r\n        // mount('#app') \u5BB9\u5668\r\n        let vnode = createVNode(rootComponent)\r\n        render(vnode, rootContainer)\r\n      },\r\n      render() {}\r\n    }\r\n    return app\r\n  }\r\n}\r\n", "import { createAppAPI } from './apiCreateApp'\r\nimport { Text } from './vnode'\r\n\r\nconst NOOP = () => {}\r\n\r\nexport function createRenderer(options) {\r\n  const {\r\n    insert: hostInsert,\r\n    remove: hostRemove,\r\n    patchProp: hostPatchProp,\r\n    createElement: hostCreateElement,\r\n    createText: hostCreateText,\r\n    createComment: hostCreateComment,\r\n    setText: hostSetText,\r\n    setElementText: hostSetElementText,\r\n    parentNode: hostParentNode,\r\n    nextSibling: hostNextSibling,\r\n    setScopeId: hostSetScopeId = NOOP,\r\n    insertStaticContent: hostInsertStaticContent\r\n  } = options\r\n\r\n  function patch(n1, n2, container) {\r\n    if (n1 === n2) {\r\n      return\r\n    }\r\n\r\n    const { type, shapeFlag } = n2\r\n    switch (type) {\r\n      case Text:\r\n        processText(n1, n2, container)\r\n      default:\r\n        console.log(1)\r\n    }\r\n  }\r\n\r\n  function processText(n1, n2, container) {\r\n    if (n1 == null) {\r\n      hostInsert((n2.el = hostCreateText(n2.children as string)), container)\r\n    } else {\r\n      const el = (n2.el = n1.el!)\r\n      if (n2.children !== n1.children) {\r\n        hostSetText(el, n2.children as string)\r\n      }\r\n    }\r\n  }\r\n\r\n  function unmount() {}\r\n\r\n  function render(vnode, container) {\r\n    console.log('\u8C03\u7528patch')\r\n    patch(container.vnode || null, vnode, container)\r\n  }\r\n\r\n  return {\r\n    render,\r\n    createApp: createAppAPI(render)\r\n  }\r\n}\r\n"],
  "mappings": "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",
  "names": ["effect", "effect"]
}
